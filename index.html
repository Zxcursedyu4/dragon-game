import logging
import sqlite3
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext
import random
import time
from enum import Enum

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
conn = sqlite3.connect('dragons.db', check_same_thread=False)
c = conn.cursor()

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
c.execute('''CREATE TABLE IF NOT EXISTS users
             (user_id INTEGER PRIMARY KEY, username TEXT, balance INTEGER, last_mission INTEGER, last_training INTEGER)''')

c.execute('''CREATE TABLE IF NOT EXISTS dragons
             (dragon_id INTEGER PRIMARY KEY AUTOINCREMENT,
              owner INTEGER, name TEXT, rarity TEXT, level INTEGER,
              exp INTEGER, strength INTEGER, agility INTEGER,
              stamina INTEGER, status TEXT, upgrade_end_time INTEGER)''')

# –†–µ–¥–∫–æ—Å—Ç–∏ –¥—Ä–∞–∫–æ–Ω–æ–≤
class Rarity(Enum):
    COMMON = "–û–±—ã—á–Ω—ã–π"
    RARE = "–†–µ–¥–∫–∏–π"
    EPIC = "–≠–ø–∏—á–µ—Å–∫–∏–π"
    LEGENDARY = "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π"
    ANCIENT = "–î—Ä–µ–≤–Ω–∏–π"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥—Ä–∞–∫–æ–Ω–∞
def generate_dragon(rarity: Rarity):
    base_stats = {
        Rarity.COMMON: (5, 5, 50),
        Rarity.RARE: (10, 10, 75),
        Rarity.EPIC: (15, 15, 100),
        Rarity.LEGENDARY: (20, 20, 150),
        Rarity.ANCIENT: (100, 100, 500)
    }
    return base_stats[rarity]

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω—é
def main_menu():
    keyboard = [
        [InlineKeyboardButton("–ú–æ–∏ –¥—Ä–∞–∫–æ–Ω—ã üê≤", callback_data='my_dragons')],
        [InlineKeyboardButton("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ ‚öîÔ∏è", callback_data='mission'),
         InlineKeyboardButton("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å üèãÔ∏è", callback_data='train')],
        [InlineKeyboardButton("–†—É–ª–µ—Ç–∫–∞ üé°", callback_data='roulette'),
         InlineKeyboardButton("–ö–µ–π—Å—ã üéÅ", callback_data='cases')]
    ]
    return InlineKeyboardMarkup(keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
def start(update: Update, context: CallbackContext):
    user = update.effective_user
    update.message.reply_html(
        f"üî• <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Dragon Kingdom, {user.mention_html()}!</b> üî•\n\n"
        "–ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –≤—ã—Ä–∞—Å—Ç–∏—Ç—å –º–æ–≥—É—á–µ–≥–æ –¥—Ä–∞–∫–æ–Ω–∞ –∏ –ø–æ–∫–æ—Ä–∏—Ç—å –≤–µ—Å—å –º–∏—Ä!",
        reply_markup=main_menu()
    )

# –°–∏—Å—Ç–µ–º–∞ –±–æ—è
def battle_system(player_dragon, enemy_dragon):
    player_dodge_chance = player_dragon['agility'] * 0.1
    enemy_dodge_chance = enemy_dragon['agility'] * 0.1
    
    # –õ–æ–≥–∏–∫–∞ –±–æ—è
    while player_dragon['stamina'] > 0 and enemy_dragon['stamina'] > 0:
        # –ê—Ç–∞–∫–∞ –∏–≥—Ä–æ–∫–∞
        if random.random() > enemy_dodge_chance:
            enemy_dragon['stamina'] -= player_dragon['strength']
        
        # –ê—Ç–∞–∫–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
        if random.random() > player_dodge_chance:
            player_dragon['stamina'] -= enemy_dragon['strength']
    
    return player_dragon['stamina'] > 0

# –†—É–ª–µ—Ç–∫–∞
def spin_roulette():
    rewards = [
        ("üí∞ 100 –º–æ–Ω–µ—Ç", 40),
        ("‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∫–∞—á–∫–∏", 25),
        ("üêâ –û–±—ã—á–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", 20),
        ("üéÅ –†–µ–¥–∫–∏–π –∫–µ–π—Å", 10),
        ("üî• –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –¥—Ä–∞–∫–æ–Ω", 5)
    ]
    return random.choices([r[0] for r in rewards], weights=[r[1] for r in rewards], k=1)[0]

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥—Ä–∞–∫–æ–Ω–∞ (–∑–∞–≥–ª—É—à–∫–∞)
def generate_dragon_image(rarity):
    arts = {
        Rarity.COMMON: "üêâ",
        Rarity.RARE: "üê≤",
        Rarity.EPIC: "üî•üêâüî•",
        Rarity.LEGENDARY: "üåãüêâüåã",
        Rarity.ANCIENT: "‚ö°üêâ‚ö°"
    }
    return arts[rarity]

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫
def button_handler(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    
    if query.data == 'my_dragons':
        # –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥—Ä–∞–∫–æ–Ω–æ–≤
        pass
    
    elif query.data == 'mission':
        # –õ–æ–≥–∏–∫–∞ –º–∏—Å—Å–∏–π
        pass
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫

def main():
    updater = Updater("YOUR_BOT_TOKEN", use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CallbackQueryHandler(button_handler))

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()